<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Order Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-badge {
            font-size: 0.8em;
            padding: 0.25em 0.5em;
        }
        .order-card {
            transition: transform 0.2s;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-shopping-cart text-primary me-2"></i>
                        <span th:text="${pageTitle}">Order Management</span>
                    </h1>
                    <div>
                        <a href="/dashboard-customer" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                        </a>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newOrderModal">
                            <i class="fas fa-plus me-1"></i>New Order
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Total Orders</h6>
                                <h3 th:text="${orders != null ? #lists.size(orders) : 0}">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-shopping-cart fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Completed</h6>
                                <h3 th:text="${orders != null ? #lists.size(orders.?[status.name() == 'DELIVERED']) : 0}">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">In Progress</h6>
                                <h3 th:text="${orders != null ? #lists.size(orders.?[status.name() == 'PREPARING' or status.name() == 'CONFIRMED']) : 0}">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Pending</h6>
                                <h3 th:text="${orders != null ? #lists.size(orders.?[status.name() == 'PENDING']) : 0}">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-hourglass-half fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>All Orders
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${orders != null and !orders.empty}" class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Order #</th>
                                        <th>Customer</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Payment</th>
                                        <th>Total</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="order : ${orders}" class="order-row">
                                        <td>
                                            <strong th:text="${order.orderNumber}">ORD-001</strong>
                                        </td>
                                        <td th:text="${order.customer != null ? order.customer.fullName : 'Unknown'}">Customer Name</td>
                                        <td>
                                            <span class="badge bg-secondary" th:text="${order.orderType}">DELIVERY</span>
                                        </td>
                                        <td>
                                            <span class="badge status-badge" 
                                                  th:classappend="${order.status.name() == 'DELIVERED'} ? 'bg-success' : 
                                                                 (${order.status.name() == 'PREPARING'} ? 'bg-warning' : 
                                                                 (${order.status.name() == 'PENDING'} ? 'bg-info' : 'bg-primary'))"
                                                  th:text="${order.status}">PENDING</span>
                                        </td>
                                        <td>
                                            <span class="badge status-badge" 
                                                  th:classappend="${order.paymentStatus.name() == 'PAID'} ? 'bg-success' : 'bg-warning'"
                                                  th:text="${order.paymentStatus}">PAID</span>
                                        </td>
                                        <td>
                                            <strong th:text="${#numbers.formatDecimal(order.totalAmount, 1, 2)}">$0.00</strong>
                                        </td>
                                        <td th:text="${#temporals.format(order.orderDate, 'MMM dd, yyyy')}">Dec 03, 2024</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary action-btn" title="View Details" 
                                                    data-action="view" th:data-order-id="${order.id}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-warning action-btn" title="Edit Order" 
                                                    data-action="edit" th:data-order-id="${order.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-success action-btn" title="Update Status" 
                                                    data-action="status" th:data-order-id="${order.id}" th:data-order-status="${order.status}">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div th:if="${orders == null or orders.empty}" class="text-center py-5">
                            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Orders Found</h5>
                            <p class="text-muted">There are no orders in the system yet.</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newOrderModal">
                                <i class="fas fa-plus me-1"></i>Create First Order
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Order Modal -->
    <div class="modal fade" id="newOrderModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>Create New Order
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newOrderForm">
                        <div class="row">
                            <!-- Customer Selection -->
                            <div class="col-md-6 mb-3">
                                <label for="customerSelect" class="form-label">Customer *</label>
                                <select class="form-select" id="customerSelect" required>
                                    <option value="">Select a customer...</option>
                                    <option th:each="c : ${customers}"
                                            th:value="${c.id}"
                                            th:text="${c.fullName + ' - ' + c.email}">
                                        Customer Option
                                    </option>
                                </select>
                            </div>
                            
                            <!-- Order Type -->
                            <div class="col-md-6 mb-3">
                                <label for="orderType" class="form-label">Order Type *</label>
                                <select class="form-select" id="orderType" required>
                                    <option value="DELIVERY">Delivery</option>
                                    <option value="PICKUP">Pickup</option>
                                    <option value="DINE_IN">Dine In</option>
                                    <option value="CATERING">Catering</option>
                                </select>
                            </div>
                        </div>

                        <!-- Delivery Address (conditional) -->
                        <div class="row" id="deliveryAddressSection" style="display: none;">
                            <div class="col-12 mb-3">
                                <label for="deliveryAddress" class="form-label">Delivery Address</label>
                                <textarea class="form-control" id="deliveryAddress" rows="2" 
                                    placeholder="Enter delivery address..."></textarea>
                            </div>
                        </div>

                        <!-- Menu Items Selection -->
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label">Menu Items *</label>
                                <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                    <div class="row">
                                        <!-- Appetizers -->
                                        <div class="col-md-6 mb-3">
                                            <h6 class="text-primary">Appetizers</h6>
                                            <div class="form-check">
                                                <input class="form-check-input menu-item-checkbox" type="checkbox" 
                                                    data-name="Caesar Salad" data-price="12.50" data-id="2">
                                                <label class="form-check-label">
                                                    Caesar Salad - $12.50
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input menu-item-checkbox" type="checkbox" 
                                                    data-name="Vegetable Soup" data-price="9.99" data-id="7">
                                                <label class="form-check-label">
                                                    Vegetable Soup - $9.99
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- Main Courses -->
                                        <div class="col-md-6 mb-3">
                                            <h6 class="text-primary">Main Courses</h6>
                                            <div class="form-check">
                                                <input class="form-check-input menu-item-checkbox" type="checkbox" 
                                                    data-name="Grilled Chicken Breast" data-price="18.99" data-id="1">
                                                <label class="form-check-label">
                                                    Grilled Chicken Breast - $18.99
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input menu-item-checkbox" type="checkbox" 
                                                    data-name="Beef Burger" data-price="15.99" data-id="3">
                                                <label class="form-check-label">
                                                    Beef Burger - $15.99
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input menu-item-checkbox" type="checkbox" 
                                                    data-name="Pasta Carbonara" data-price="16.99" data-id="5">
                                                <label class="form-check-label">
                                                    Pasta Carbonara - $16.99
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input menu-item-checkbox" type="checkbox" 
                                                    data-name="Fish Tacos" data-price="14.99" data-id="6">
                                                <label class="form-check-label">
                                                    Fish Tacos - $14.99
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- Desserts -->
                                        <div class="col-md-6 mb-3">
                                            <h6 class="text-primary">Desserts</h6>
                                            <div class="form-check">
                                                <input class="form-check-input menu-item-checkbox" type="checkbox" 
                                                    data-name="Chocolate Cake" data-price="8.99" data-id="4">
                                                <label class="form-check-label">
                                                    Chocolate Cake - $8.99
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input menu-item-checkbox" type="checkbox" 
                                                    data-name="Tiramisu" data-price="7.99" data-id="8">
                                                <label class="form-check-label">
                                                    Tiramisu - $7.99
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Selected Items Summary -->
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label">Selected Items</label>
                                <div id="selectedItemsList" class="border rounded p-3" style="min-height: 100px;">
                                    <p class="text-muted">No items selected</p>
                                </div>
                            </div>
                        </div>

                        <!-- Special Instructions -->
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="specialInstructions" class="form-label">Special Instructions</label>
                                <textarea class="form-control" id="specialInstructions" rows="3" 
                                    placeholder="Any special requests or instructions for this order..."></textarea>
                            </div>
                        </div>

                        <!-- Order Summary -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Order Summary</h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <small class="text-muted">Subtotal:</small>
                                            </div>
                                            <div class="col-6 text-end">
                                                <span id="orderSubtotal">$0.00</span>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                <small class="text-muted">Tax (8%):</small>
                                            </div>
                                            <div class="col-6 text-end">
                                                <span id="orderTax">$0.00</span>
                                            </div>
                                        </div>
                                        <div class="row" id="deliveryFeeRow" style="display: none;">
                                            <div class="col-6">
                                                <small class="text-muted">Delivery Fee:</small>
                                            </div>
                                            <div class="col-6 text-end">
                                                <span id="orderDeliveryFee">$5.00</span>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Total:</strong>
                                            </div>
                                            <div class="col-6 text-end">
                                                <strong id="orderTotal">$0.00</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createOrderBtn" disabled>
                        <i class="fas fa-check me-1"></i>Create Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Order Creation JavaScript
        let selectedItems = [];
        
        // Initialize form functionality
        document.addEventListener('DOMContentLoaded', function() {
            initializeOrderForm();
        });
        
        function initializeOrderForm() {
            // Order type change handler
            document.getElementById('orderType').addEventListener('change', function() {
                const deliverySection = document.getElementById('deliveryAddressSection');
                const deliveryFeeRow = document.getElementById('deliveryFeeRow');
                
                if (this.value === 'DELIVERY' || this.value === 'CATERING') {
                    deliverySection.style.display = 'block';
                    deliveryFeeRow.style.display = 'block';
                } else {
                    deliverySection.style.display = 'none';
                    deliveryFeeRow.style.display = 'none';
                }
                updateOrderSummary();
            });
            
            // Menu item checkbox handlers
            document.querySelectorAll('.menu-item-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateSelectedItems();
                    updateOrderSummary();
                    updateCreateButton();
                });
            });
            
            // Customer selection handler
            document.getElementById('customerSelect').addEventListener('change', updateCreateButton);
            
            // Action button handlers using event delegation
            document.addEventListener('click', function(e) {
                if (e.target.closest('.action-btn')) {
                    const button = e.target.closest('.action-btn');
                    const action = button.getAttribute('data-action');
                    const orderId = button.getAttribute('data-order-id');
                    const orderStatus = button.getAttribute('data-order-status');
                    
                    console.log('Button clicked:', action, 'Order ID:', orderId, 'Status:', orderStatus);
                    
                    switch(action) {
                        case 'view':
                            viewOrderDetails(orderId);
                            break;
                        case 'edit':
                            editOrder(orderId);
                            break;
                        case 'status':
                            updateOrderStatus(orderId, orderStatus);
                            break;
                    }
                }
            });
        }
        
        function updateSelectedItems() {
            selectedItems = [];
            document.querySelectorAll('.menu-item-checkbox:checked').forEach(checkbox => {
                selectedItems.push({
                    id: checkbox.dataset.id,
                    name: checkbox.dataset.name,
                    price: parseFloat(checkbox.dataset.price),
                    quantity: 1
                });
            });
            
            // Update selected items display
            const selectedItemsList = document.getElementById('selectedItemsList');
            if (selectedItems.length === 0) {
                selectedItemsList.innerHTML = '<p class="text-muted">No items selected</p>';
            } else {
                let html = '';
                selectedItems.forEach(item => {
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                            <div>
                                <strong>${item.name}</strong>
                                <br><small class="text-muted">$${item.price.toFixed(2)}</small>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="changeQuantity('${item.id}', -1)">-</button>
                                <span class="btn btn-outline-primary">${item.quantity}</span>
                                <button type="button" class="btn btn-outline-secondary" onclick="changeQuantity('${item.id}', 1)">+</button>
                            </div>
                        </div>
                    `;
                });
                selectedItemsList.innerHTML = html;
            }
        }
        
        function changeQuantity(itemId, change) {
            const item = selectedItems.find(i => i.id === itemId);
            if (item) {
                item.quantity = Math.max(1, item.quantity + change);
                updateSelectedItems();
                updateOrderSummary();
            }
        }
        
        function updateOrderSummary() {
            const subtotal = selectedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const taxRate = 0.08; // 8% tax
            const tax = subtotal * taxRate;
            const deliveryFee = (document.getElementById('orderType').value === 'DELIVERY' || 
                               document.getElementById('orderType').value === 'CATERING') ? 5.00 : 0;
            const total = subtotal + tax + deliveryFee;
            
            document.getElementById('orderSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('orderTax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('orderDeliveryFee').textContent = `$${deliveryFee.toFixed(2)}`;
            document.getElementById('orderTotal').textContent = `$${total.toFixed(2)}`;
        }
        
        function updateCreateButton() {
            const customerSelected = document.getElementById('customerSelect').value !== '';
            const hasItems = selectedItems.length > 0;
            const createBtn = document.getElementById('createOrderBtn');
            
            createBtn.disabled = !(customerSelected && hasItems);
        }
        
        // Create order function
        document.getElementById('createOrderBtn').addEventListener('click', function() {
            if (this.disabled) return;
            
            // Validate required fields
            const customerId = document.getElementById('customerSelect').value;
            const orderType = document.getElementById('orderType').value;
            
            if (!customerId || selectedItems.length === 0) {
                alert('Please select a customer and at least one menu item.');
                return;
            }
            
            const orderData = {
                customerId: parseInt(customerId),
                orderType: orderType,
                deliveryAddress: document.getElementById('deliveryAddress').value || null,
                specialInstructions: document.getElementById('specialInstructions').value || null,
                items: selectedItems.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                }))
            };
            
            console.log('Sending order data:', orderData); // Debug log
            
            // Show loading state
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';
            
            // Create order via API
            fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            })
            .then(response => {
                console.log('Response status:', response.status); // Debug log
                if (response.ok) {
                    return response.json();
                }
                return response.text().then(text => {
                    throw new Error(`Server error: ${response.status} - ${text}`);
                });
            })
            .then(order => {
                // Success - show success message and close modal
                alert('Order created successfully! Order #: ' + order.orderNumber);
                
                // Reset form
                document.getElementById('newOrderForm').reset();
                selectedItems = [];
                updateSelectedItems();
                updateOrderSummary();
                updateCreateButton();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('newOrderModal'));
                modal.hide();
                
                // Reload page to show new order
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating order: ' + error.message);
            })
            .finally(() => {
                // Reset button state
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-check me-1"></i>Create Order';
            });
        });
        
        // Order Action Functions
        function viewOrderDetails(orderId) {
            console.log('View order details called with ID:', orderId);
            alert('View button clicked for order ID: ' + orderId);
            
            fetch(`/api/orders/${orderId}`)
                .then(response => {
                    console.log('Response received:', response.status);
                    return response.json();
                })
                .then(order => {
                    console.log('Order data:', order);
                    showOrderDetailsModal(order);
                })
                .catch(error => {
                    console.error('Error fetching order details:', error);
                    alert('Error loading order details: ' + error.message);
                });
        }
        
        function editOrder(orderId) {
            console.log('Edit order called with ID:', orderId);
            alert('Edit button clicked for order ID: ' + orderId);
            
            fetch(`/api/orders/${orderId}`)
                .then(response => response.json())
                .then(order => {
                    showEditOrderModal(order);
                })
                .catch(error => {
                    console.error('Error fetching order for editing:', error);
                    alert('Error loading order for editing');
                });
        }
        
        function updateOrderStatus(orderId, currentStatus) {
            console.log('Update order status called with ID:', orderId, 'Current status:', currentStatus);
            alert('Update status button clicked for order ID: ' + orderId + ', Current status: ' + currentStatus);
            showStatusUpdateModal(orderId, currentStatus);
        }
        
        function showOrderDetailsModal(order) {
            const modalHtml = `
                <div class="modal fade" id="viewOrderModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-eye me-2"></i>Order Details - ${order.orderNumber}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Order Information</h6>
                                        <p><strong>Order #:</strong> ${order.orderNumber}</p>
                                        <p><strong>Customer:</strong> ${order.customer ? order.customer.fullName : 'Unknown'}</p>
                                        <p><strong>Type:</strong> <span class="badge bg-secondary">${order.orderType}</span></p>
                                        <p><strong>Status:</strong> <span class="badge bg-info">${order.status}</span></p>
                                        <p><strong>Payment:</strong> <span class="badge bg-warning">${order.paymentStatus}</span></p>
                                        <p><strong>Date:</strong> ${new Date(order.orderDate).toLocaleDateString()}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Financial Information</h6>
                                        <p><strong>Subtotal:</strong> $${order.subtotal.toFixed(2)}</p>
                                        <p><strong>Tax:</strong> $${order.taxAmount.toFixed(2)}</p>
                                        <p><strong>Delivery Fee:</strong> $${order.deliveryFee.toFixed(2)}</p>
                                        <p><strong>Total:</strong> $${order.totalAmount.toFixed(2)}</p>
                                    </div>
                                </div>
                                ${order.deliveryAddress ? `
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <h6>Delivery Information</h6>
                                            <p><strong>Address:</strong> ${order.deliveryAddress}</p>
                                        </div>
                                    </div>
                                ` : ''}
                                ${order.specialInstructions ? `
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <h6>Special Instructions</h6>
                                            <p>${order.specialInstructions}</p>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('viewOrderModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add new modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('viewOrderModal'));
            modal.show();
        }
        
        function showEditOrderModal(order) {
            const modalHtml = `
                <div class="modal fade" id="editOrderModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-edit me-2"></i>Edit Order - ${order.orderNumber}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editOrderForm">
                                    <input type="hidden" id="editOrderId" value="${order.id}">
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Order Type</label>
                                        <select class="form-select" id="editOrderType" disabled>
                                            <option value="DELIVERY" ${order.orderType === 'DELIVERY' ? 'selected' : ''}>Delivery</option>
                                            <option value="PICKUP" ${order.orderType === 'PICKUP' ? 'selected' : ''}>Pickup</option>
                                            <option value="DINE_IN" ${order.orderType === 'DINE_IN' ? 'selected' : ''}>Dine In</option>
                                            <option value="CATERING" ${order.orderType === 'CATERING' ? 'selected' : ''}>Catering</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3" id="editDeliverySection" style="display: ${order.orderType === 'DELIVERY' || order.orderType === 'CATERING' ? 'block' : 'none'}">
                                        <label for="editDeliveryAddress" class="form-label">Delivery Address</label>
                                        <textarea class="form-control" id="editDeliveryAddress" rows="2">${order.deliveryAddress || ''}</textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="editSpecialInstructions" class="form-label">Special Instructions</label>
                                        <textarea class="form-control" id="editSpecialInstructions" rows="3">${order.specialInstructions || ''}</textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Order Status</label>
                                        <select class="form-select" id="editOrderStatus">
                                            <option value="PENDING" ${order.status === 'PENDING' ? 'selected' : ''}>Pending</option>
                                            <option value="CONFIRMED" ${order.status === 'CONFIRMED' ? 'selected' : ''}>Confirmed</option>
                                            <option value="PREPARING" ${order.status === 'PREPARING' ? 'selected' : ''}>Preparing</option>
                                            <option value="READY" ${order.status === 'READY' ? 'selected' : ''}>Ready</option>
                                            <option value="OUT_FOR_DELIVERY" ${order.status === 'OUT_FOR_DELIVERY' ? 'selected' : ''}>Out for Delivery</option>
                                            <option value="DELIVERED" ${order.status === 'DELIVERED' ? 'selected' : ''}>Delivered</option>
                                            <option value="COMPLETED" ${order.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                                            <option value="CANCELLED" ${order.status === 'CANCELLED' ? 'selected' : ''}>Cancelled</option>
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="saveOrderBtn">
                                    <i class="fas fa-save me-1"></i>Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('editOrderModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editOrderModal'));
            modal.show();
            
            // Add save button handler
            document.getElementById('saveOrderBtn').addEventListener('click', function() {
                const orderId = document.getElementById('editOrderId').value;
                const updatedOrder = {
                    id: parseInt(orderId),
                    deliveryAddress: document.getElementById('editDeliveryAddress').value,
                    specialInstructions: document.getElementById('editSpecialInstructions').value,
                    status: document.getElementById('editOrderStatus').value
                };
                
                // Show loading state
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
                
                // Update order via API
                fetch(`/api/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedOrder)
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Failed to update order');
                })
                .then(order => {
                    alert('Order updated successfully!');
                    modal.hide();
                    location.reload();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating order: ' + error.message);
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-save me-1"></i>Save Changes';
                });
            });
        }
        
        function showStatusUpdateModal(orderId, currentStatus) {
            const statusOptions = [
                { value: 'PENDING', label: 'Pending', color: 'bg-info' },
                { value: 'CONFIRMED', label: 'Confirmed', color: 'bg-primary' },
                { value: 'PREPARING', label: 'Preparing', color: 'bg-warning' },
                { value: 'READY', label: 'Ready', color: 'bg-success' },
                { value: 'DELIVERED', label: 'Delivered', color: 'bg-success' },
                { value: 'CANCELLED', label: 'Cancelled', color: 'bg-danger' }
            ];
            
            const modalHtml = `
                <div class="modal fade" id="statusUpdateModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-check me-2"></i>Update Order Status
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Update the status for order ID: <strong>${orderId}</strong></p>
                                <div class="mb-3">
                                    <label for="newStatus" class="form-label">New Status</label>
                                    <select class="form-select" id="newStatus">
                                        ${statusOptions.map(status => 
                                            `<option value="${status.value}" ${status.value === currentStatus ? 'selected' : ''}>
                                                ${status.label}
                                            </option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="statusReason" class="form-label">Reason (Optional)</label>
                                    <textarea class="form-control" id="statusReason" rows="3" 
                                        placeholder="Enter reason for status change..."></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="confirmStatusUpdate(${orderId})">
                                    Update Status
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('statusUpdateModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add new modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('statusUpdateModal'));
            modal.show();
        }
        
        function confirmStatusUpdate(orderId) {
            const newStatus = document.getElementById('newStatus').value;
            const reason = document.getElementById('statusReason').value;
            
            const updateData = {
                status: newStatus,
                reason: reason || 'Status updated'
            };
            
            fetch(`/api/orders/${orderId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to update order status');
            })
            .then(updatedOrder => {
                alert('Order status updated successfully!');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal'));
                modal.hide();
                
                // Reload page to show updated status
                location.reload();
            })
            .catch(error => {
                console.error('Error updating order status:', error);
                alert('Error updating order status: ' + error.message);
            });
        }
    </script>
</body>
</html>